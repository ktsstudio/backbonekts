/*! 
* backbonekts - v0.2.5 - 2015-11-06
* http://gitlab.ktsstudio.ru/kts-libs/backbonekts
* Copyright (c) 2015 kts
* Licensed MIT 
*/

!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["backbone","underscore","notific","jquery"],b):"object"==typeof a?b.exports=b():a.BackboneKTS=b()}("object"==typeof exports&&exports||this,function(a,b,c,d){var e={};return e.log=function(){console&&b.isFunction(console.log)&&console.log.apply(console,arguments)},e.error=function(){console&&b.isFunction(console.error)&&console.error.apply(console,arguments)},e.viewManagerMixin={_viewsInstance:{},views:{},_getViewByName:function(a){if("undefined"==typeof this._viewsInstance[a]){var b=this.views[a];if("undefined"==typeof b)return null;this._viewsInstance[a]=new b}return this._viewsInstance[a]}},e.htmlGeneratorMixin={html:{select:function(a){var c='<select class="form-control" name="'+a.name+'">',d=b.template('<option value="<%- value %>" <%- selected %>><%- title %></option>');for(var e in a.values)a.values.hasOwnProperty(e)&&(c+=d({value:e,selected:e===a.selected?"selected":"",title:a.values[e]}));return c+="</select>"}}},e.validationMixin={validateEmail:function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return b.test(a)}},e.Collection=a.Collection.extend({totalCount:0,pageCount:0,offset:0,pageSize:10,getBeginPagination:function(a){var b=a/this.pageSize-3;return 0>b&&(b=0),b},getEndPagination:function(a){var b=a/this.pageSize+3;return b>this.pageCount&&(b=this.pageCount),b},parse:function(a){return this.totalCount=a.data.count,this.pageCount=parseInt(this.totalCount/this.pageSize,10)+(this.totalCount%this.pageSize>0?1:0),[].slice?(a.data.items||a.data||[]).slice(0,this.totalCount):a.data.items||a.data||[]}}),e.Config={apiURL:!1,apiPersistentData:{v:"1"},apiMethod:"get",staticPrefix:!1,mediaPrefix:!1,webRoot:!1,imgResizerUrl:!1,queryString:function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d+=1){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=decodeURIComponent(e[1]);else if("string"==typeof a[e[0]]){var f=[a[e[0]],decodeURIComponent(e[1])];a[e[0]]=f}else a[e[0]].push(decodeURIComponent(e[1]))}return a}(),getMethodUrl:function(a,b){var c=this.apiURL+a,d=[];if("object"==typeof b)for(var e in b)void 0!==b[e]&&d.push(e+"="+encodeURIComponent(b[e]));return d.length&&(c+="?"+d.join("&")),c},getStaticUrl:function(a){return this.webRoot+this.staticPrefix+a},getMediaUrl:function(a){return this.webRoot+this.mediaPrefix+a},apiCall:function(a,c,e){e=e||{},c=c||{};var f=b.extend({},this.apiPersistentData,c);d.ajax({method:e.method||this.apiMethod,url:this.getMethodUrl(a),data:f,beforeSend:e.onProgressStart||function(){},complete:e.onProgressEnd||function(){},success:e.onSuccess||function(){},error:e.onError||function(){}})},getImgCropUrl:function(a,b,c){return this._getImgFilterUrl(a,b,c,"crop")},getImgResizeUrl:function(a,b,c){return this._getImgFilterUrl(a,b,c,"resize")},_getImgFilterUrl:function(a,b,c,d){return b=parseInt(b,10),c=parseInt(c,10),b=isNaN(b)?"-":String(b),c=isNaN(c)?"-":String(c),this.imgResizerUrl+"/"+d+"/"+b+"x"+c+"?url="+a}},e.Model=a.Model.extend({parse:function(a,b){if(b.collection)return a;try{return a.data.items[0]}catch(c){return{}}},_backboneSync:function(c,f,g){var h={create:"POST",update:"POST",patch:"POST","delete":"POST",read:"GET"},i=h[c];b.defaults(g||(g={}),{emulateHTTP:a.emulateHTTP,emulateJSON:!a.emulateJSON});var j={type:i,dataType:"json"};if(g.url||(j.url=b.result(f,"url")||e.error("URL not defined")),null!==g.data||!f||"create"!==c&&"update"!==c&&"patch"!==c||(j.contentType="application/json",j.data=JSON.stringify(g.attrs||f.toJSON(g))),g.emulateJSON&&(j.contentType="application/x-www-form-urlencoded",j.data=g.attrs||f.toJSON(g),"object"==typeof j.data&&(j.data=d.param(j.data))),g.emulateHTTP&&("PUT"===i||"DELETE"===i||"PATCH"===i)){j.type="POST",g.emulateJSON&&(j.data._method=i);var k=g.beforeSend;g.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",i),k?k.apply(this,arguments):void 0}}"GET"===j.type||g.emulateJSON||(j.processData=!1);var l=g.xhr=a.ajax(b.extend(j,g));return f.trigger("request",f,l,g),l},sync:function(){return this._backboneSync.apply(this,arguments)}}),e.Router=a.Router.extend(b.extend({redirect:function(b){a.history.navigate("/"+b,!0)}},e.viewManagerMixin)),e.View=a.View.extend(b.extend({el:"#content",redirect:function(b){a.history.navigate("/"+b,!0)},random:function(){return parseInt(Math.random()*Math.pow(2,31),10)},beforeAction:function(){},afterAction:function(){},render:function(){var a=arguments[0],b=null;"string"!=typeof a?(a="index",b=Array.prototype.slice.call(arguments,0)):b=Array.prototype.slice.call(arguments,1),this.beforeAction();var c=a.charAt(0).toUpperCase()+a.substring(1).toLowerCase(),d="action"+c;"function"==typeof this[d]?this[d].apply(this,b):this._defaultAction(),this.afterAction()},serializeForm:function(a,c){var e={};return b.each(d(a).serializeArray(),function(a){var b=/\[(\w+)\]/gi,c=a.name.match(b);if(null===c)e[a.name]=a.value;else{var d=a.name.slice(0,a.name.search(b)),f=function(a,b,c){if(0===b.length)return isNaN(parseInt(c,10))||String(parseInt(c,10)).length!==c.length?isNaN(parseFloat(c))||String(parseFloat(c)).length!==c.length?c:parseFloat(c):parseInt(c,10);var d=b[0].slice(1,b[0].length-1);return isNaN(parseInt(d,10))||String(parseInt(d,10)).length!==d.length?void 0===a&&(a={}):void 0===a&&(a=[]),a[d]=f(a[d],b.slice(1),c),a};e[d]=f(e[d],c,a.value)}}),b.map(e,function(a,b){if("object"==typeof a){if(Array.isArray(a)){var d=[];for(var f in a)null!==a[f]&&void 0!==a[f]&&d.push(a[f]);a=d}c!==!0&&(e[b]=JSON.stringify(a))}}),e},_defaultAction:function(){this.$el.html(d("<h1/>",{html:"404"}))},_showSuccess:function(a,b){void 0===a&&(a="Выполнено"),void 0!==c?c.success({title:a,text:b,timeout:2e3}):e.debugLog("Notific is undefined")},_showError:function(a,b){void 0===a&&(a="Ошибка"),void 0!==c?c.error({title:a,text:b,timeout:2e3}):e.debugLog("Notific is undefined")}},e.viewManagerMixin,e.validationMixin,e.htmlGeneratorMixin)),e});